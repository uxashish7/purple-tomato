name: GitHub Actions workflow for IOS builds

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allows manual trigger

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.38.5'
        channel: 'stable'
    
    - name: Get dependencies
      run: flutter pub get
    
    - name: Generate app icons
      run: dart run flutter_launcher_icons
    
    - name: Build iOS (Simulator)
      run: flutter build ios --debug --simulator --no-codesign
    
    - name: Find and package .app for Appetize
      run: |
        # Find the .app bundle
        APP_PATH=$(find build/ios -name "*.app" -type d | head -1)
        echo "Found app at: $APP_PATH"
        
        # Create a zip with .app at root level (required by Appetize)
        cd "$(dirname "$APP_PATH")"
        zip -r "$GITHUB_WORKSPACE/purple-tomato-ios.zip" "$(basename "$APP_PATH")"
        
        echo "Created zip at: $GITHUB_WORKSPACE/purple-tomato-ios.zip"
        unzip -l "$GITHUB_WORKSPACE/purple-tomato-ios.zip" | head -20
    
    - name: Upload iOS App for Appetize
      uses: actions/upload-artifact@v4
      with:
        name: purple-tomato-ios
        path: purple-tomato-ios.zip
        retention-days: 30
